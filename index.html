<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker NM</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        label {
            min-width: 120px;
            font-weight: 500;
            color: #555;
        }

        input[type="number"] {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            width: 70px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .timer-section {
            text-align: center;
        }

        .timer-display {
            font-size: 3em;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-section {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-weight: 500;
        }

        .time-planned { color: #667eea; }
        .time-spent { color: #56ab2f; }
        .time-remaining { color: #ff6b6b; }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status.running {
            background: linear-gradient(45deg, rgba(86, 171, 47, 0.2), rgba(168, 230, 207, 0.2));
            color: #2d7d32;
            border: 2px solid #56ab2f;
        }

        .status.stopped {
            background: linear-gradient(45deg, rgba(255, 107, 107, 0.2), rgba(255, 75, 43, 0.2));
            color: #c62828;
            border: 2px solid #ff6b6b;
        }

        .timer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-start { background: linear-gradient(45deg, #56ab2f, #a8e6cf); }
        .btn-stop { background: linear-gradient(45deg, #ff416c, #ff4b2b); }
        .btn-reset { background: linear-gradient(45deg, #ffa726, #ffcc02); }
        .btn-save { background: linear-gradient(45deg, #667eea, #764ba2); }

        .card-badge {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚è±Ô∏è Time Tracker NM</h1>

        <div class="section">
            <h2>üìã Planowanie czasu</h2>
            <div class="input-group">
                <label>Godziny:</label>
                <input type="number" id="plannedHours" min="0" max="999" value="0">
                <label>Minuty:</label>
                <input type="number" id="plannedMinutes" min="0" max="59" value="0">
                <button onclick="setPlannedTime()">Zapisz planowany czas</button>
            </div>
        </div>

        <div class="section">
            <h2>‚è∞ Ju≈º przepracowany czas</h2>
            <div class="input-group">
                <label>Godziny:</label>
                <input type="number" id="spentHours" min="0" max="999" value="0">
                <label>Minuty:</label>
                <input type="number" id="spentMinutes" min="0" max="59" value="0">
                <button onclick="setSpentTime()">Zapisz przepracowany czas</button>
            </div>
        </div>

        <div class="section progress-section">
            <h2>üìä Postƒôp zadania</h2>
            <div class="time-info">
                <span class="time-planned">Planowane: <span id="displayPlanned">0:00</span></span>
                <span class="time-spent">Przepracowane: <span id="displaySpent">0:00</span></span>
                <span class="time-remaining">Pozosta≈Ço: <span id="displayRemaining">0:00</span></span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="section timer-section">
            <h2>‚è±Ô∏è Timer na ≈ºywo</h2>
            <div class="timer-display" id="timerDisplay">00:00:00</div>
            <div class="status stopped" id="timerStatus">Timer zatrzymany</div>
            <div class="timer-buttons">
                <button class="btn-start" onclick="startTimer()">‚ñ∂Ô∏è Start</button>
                <button class="btn-stop" onclick="stopTimer()">‚è∏Ô∏è Stop</button>
                <button class="btn-reset" onclick="resetTimer()">üîÑ Reset</button>
                <button class="btn-save" onclick="addTimerToSpent()">üíæ Dodaj do przepracowanego</button>
            </div>
        </div>
    </div>

    <script>
        // Sprawd≈∫ czy jeste≈õmy w iframe Trello
        if (window.parent === window) {
            // Je≈õli otwarte bezpo≈õrednio, poka≈º instrukcjƒô
            document.body.innerHTML = `
                <div class="container">
                    <h1>‚è±Ô∏è Time Tracker NM</h1>
                    <div class="section">
                        <h2>üìã Instrukcja</h2>
                        <p>Ten Power-Up dzia≈Ça tylko w kontek≈õcie Trello.</p>
                        <p>Aby go u≈ºywaƒá:</p>
                        <ol>
                            <li>Przejd≈∫ do tablicy Trello</li>
                            <li>Kliknij w konkretnƒÖ kartƒô</li>
                            <li>Znajd≈∫ przycisk "‚è±Ô∏è Time Tracker NM"</li>
                        </ol>
                    </div>
                </div>
            `;
            throw new Error('Not in Trello context');
        }

        // Inicjalizacja Power-Up
        let t = window.TrelloPowerUp.initialize({
            'show-settings': function(t, options) {
                // Ta funkcja siƒô wykona gdy klikniesz "Settings" przy Power-Up
                return t.popup({
                    title: 'Time Tracker NM - Ustawienia',
                    url: 'https://novit-media.github.io/time-tracker-nm-trello/index.html',
                    height: 650
                });
            },
            'board-buttons': function(t, options) {
                // Przycisk na g≈Ç√≥wnej tablicy
                return [{
                    text: '‚è±Ô∏è Time Tracker NM',
                    icon: './icon.png',
                    callback: function(t) {
                        return t.popup({
                            title: 'Time Tracker NM - Tablicy',
                            url: 'https://novit-media.github.io/time-tracker-nm-trello/index.html',
                            height: 650
                        });
                    }
                }];
            },
            'card-badges': function(t, options) {
                return t.get('card', 'shared', 'timeData', {})
                .then(function(timeData) {
                    let badges = [];

                    if (timeData.plannedMinutes > 0) {
                        let plannedHours = Math.floor(timeData.plannedMinutes / 60);
                        let plannedMins = timeData.plannedMinutes % 60;
                        let plannedText = plannedHours > 0 ? `${plannedHours}:${plannedMins.toString().padStart(2, '0')}h` : `${plannedMins}m`;

                        badges.push({
                            text: `‚è±Ô∏è ${plannedText}`,
                            color: 'blue'
                        });
                    }

                    if (timeData.spentMinutes > 0) {
                        let spentHours = Math.floor(timeData.spentMinutes / 60);
                        let spentMins = timeData.spentMinutes % 60;
                        let spentText = spentHours > 0 ? `${spentHours}:${spentMins.toString().padStart(2, '0')}h` : `${spentMins}m`;

                        badges.push({
                            text: `‚úÖ ${spentText}`,
                            color: 'green'
                        });
                    }

                    return badges;
                });
            },
            'card-buttons': function(t, options) {
                return [{
                    text: '‚è±Ô∏è Time Tracker NM',
                    icon: './icon.png',
                    callback: function(t) {
                        return t.popup({
                            title: 'Time Tracker NM',
                            url: 'https://novit-media.github.io/time-tracker-nm-trello/index.html',
                            height: 650,
                            args: { cardId: options.context.card }
                        });
                    }
                }];
            },
        });

        // Zmienne globalne
        let timerInterval = null;
        let currentTimerSeconds = 0;
        let isTimerRunning = false;

        // Funkcje do zarzƒÖdzania danymi
        function loadTimeData() {
            return t.get('card', 'shared', 'timeData', {
                plannedMinutes: 0,
                spentMinutes: 0
            });
        }

        function saveTimeData(timeData) {
            return t.set('card', 'shared', 'timeData', timeData);
        }

        function setPlannedTime() {
            let hours = parseInt(document.getElementById('plannedHours').value) || 0;
            let minutes = parseInt(document.getElementById('plannedMinutes').value) || 0;
            let totalMinutes = hours * 60 + minutes;

            loadTimeData().then(timeData => {
                timeData.plannedMinutes = totalMinutes;
                saveTimeData(timeData).then(() => {
                    updateDisplay();
                    t.alert({
                        message: 'Planowany czas zosta≈Ç zapisany!',
                        duration: 3
                    });
                });
            });
        }

        function setSpentTime() {
            let hours = parseInt(document.getElementById('spentHours').value) || 0;
            let minutes = parseInt(document.getElementById('spentMinutes').value) || 0;
            let totalMinutes = hours * 60 + minutes;

            loadTimeData().then(timeData => {
                timeData.spentMinutes = totalMinutes;
                saveTimeData(timeData).then(() => {
                    updateDisplay();
                    t.alert({
                        message: 'Przepracowany czas zosta≈Ç zapisany!',
                        duration: 3
                    });
                });
            });
        }

        function formatTime(totalMinutes) {
            let hours = Math.floor(totalMinutes / 60);
            let minutes = totalMinutes % 60;
            return hours > 0 ? `${hours}:${minutes.toString().padStart(2, '0')}` : `${minutes}`;
        }

        function formatTimerTime(seconds) {
            let hours = Math.floor(seconds / 3600);
            let minutes = Math.floor((seconds % 3600) / 60);
            let secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            loadTimeData().then(timeData => {
                let planned = timeData.plannedMinutes;
                let spent = timeData.spentMinutes;
                let remaining = Math.max(0, planned - spent);

                document.getElementById('displayPlanned').textContent = formatTime(planned);
                document.getElementById('displaySpent').textContent = formatTime(spent);
                document.getElementById('displayRemaining').textContent = formatTime(remaining);

                // Aktualizuj pasek postƒôpu
                let progress = planned > 0 ? Math.min(100, (spent / planned) * 100) : 0;
                document.getElementById('progressFill').style.width = progress + '%';

                // Ustaw kolory w zale≈ºno≈õci od postƒôpu
                let progressFill = document.getElementById('progressFill');
                if (progress >= 100) {
                    progressFill.style.background = 'linear-gradient(45deg, #ff6b6b, #ff4b2b)';
                } else if (progress >= 80) {
                    progressFill.style.background = 'linear-gradient(45deg, #ffa726, #ffcc02)';
                } else {
                    progressFill.style.background = 'linear-gradient(45deg, #56ab2f, #a8e6cf)';
                }
            });
        }

        // Funkcje timera
        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                document.getElementById('timerStatus').textContent = 'Timer uruchomiony';
                document.getElementById('timerStatus').className = 'status running';

                timerInterval = setInterval(() => {
                    currentTimerSeconds++;
                    document.getElementById('timerDisplay').textContent = formatTimerTime(currentTimerSeconds);
                }, 1000);
            }
        }

        function stopTimer() {
            if (isTimerRunning) {
                isTimerRunning = false;
                clearInterval(timerInterval);
                document.getElementById('timerStatus').textContent = 'Timer zatrzymany';
                document.getElementById('timerStatus').className = 'status stopped';
            }
        }

        function resetTimer() {
            stopTimer();
            currentTimerSeconds = 0;
            document.getElementById('timerDisplay').textContent = formatTimerTime(0);
        }

        function addTimerToSpent() {
            if (currentTimerSeconds > 0) {
                let timerMinutes = Math.ceil(currentTimerSeconds / 60);

                loadTimeData().then(timeData => {
                    timeData.spentMinutes += timerMinutes;
                    saveTimeData(timeData).then(() => {
                        updateDisplay();
                        resetTimer();
                        t.alert({
                            message: `Dodano ${timerMinutes} minut do przepracowanego czasu!`,
                            duration: 3
                        });

                        // Aktualizuj warto≈õci w polach input
                        let newSpentHours = Math.floor(timeData.spentMinutes / 60);
                        let newSpentMinutes = timeData.spentMinutes % 60;
                        document.getElementById('spentHours').value = newSpentHours;
                        document.getElementById('spentMinutes').value = newSpentMinutes;
                    });
                });
            } else {
                t.alert({
                    message: 'Timer nie by≈Ç uruchomiony!',
                    duration: 3
                });
            }
        }

        // Inicjalizacja po za≈Çadowaniu
        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();

            // Za≈Çaduj istniejƒÖce dane do p√≥l input
            loadTimeData().then(timeData => {
                let plannedHours = Math.floor(timeData.plannedMinutes / 60);
                let plannedMinutes = timeData.plannedMinutes % 60;
                let spentHours = Math.floor(timeData.spentMinutes / 60);
                let spentMinutes = timeData.spentMinutes % 60;

                document.getElementById('plannedHours').value = plannedHours;
                document.getElementById('plannedMinutes').value = plannedMinutes;
                document.getElementById('spentHours').value = spentHours;
                document.getElementById('spentMinutes').value = spentMinutes;
            });
        });
    </script>
</body>
</html>
